**PosgreSQL. Сбор и использование  статистики.**
1.	Зачем и как Postgres собирает статистику. И что собирает.
2.	Разберём основные системные представления для статистики.
3.	Попрактикуемся на реальной базе данных

# Зачем собирать статистику?

Постресу нужно анализировать её, чтобы строить правильные планы.
Для пользователей. Можем мониторить статистику, алерты прописывать и свои аггрегации создавать.

# Как собирает статистику?

Каждый backend процесс собирает статистику.
Сбор с backend осуществляет процесс stats collector.
Каждые полсекунды статистика сбрасывает в каталог $PGDATA/pg_stat_tmp. При оставовки сервера статистика статистика записывается $PGDATA/pg_stat. Статистику можно сбросить через pg_stat_reset() 
- на уровне БД и
- на уровне кластера.

# Команды для запуска сбора статистики

- Analyze запускает ручной сбор статистике по таблице и базе данных 
- Autovacuum - обновление статистики может инициировать фоновые процессы, такие, как autovacuum.
# Настройки.
## Включение/отключение сбора статистики:
 track_activities включает мониторинг текущих команд, выполняемой любым серверным процессом.
 track_counts определяет, будет ли собираться накопительная статистика по обращениям к таблицам и индексам.
 track_functions включает отслеживание использования пользовательских функций.
 track_io_timing включает мониторинг времени чтения и записи блоков.
 track_wal_io_timing включает мониторинг времени записи WAL.
 
## Настройка autovacuum

- autovacuum_analyze_scale_factor : Определяет, какая часть строк в таблице должна измениться, прежде чем будет выполнен сбор статистики. current_setting('autovacuum_analyze_scale_factor') . Равен 0.1(или 10% таблицы)
- autovacuum_analyze_threshold : Определяет минимальное количество измененных строк, необходимых для запуска сбора статистики. По умолчанию 50. 
- default_statistics_target : Устанавливает количество значений, которые PostgreSQL анализирует при сборе статистики для столбцов. По умолчанию 100.
Количество строк анализируемых: N * 300. Можно задавать глобально, а также ALTER TABLE ... ALTER COLUMN ... SET STATISTICS

# Системные представления 
## pg_stat_database. Информация в разрезе базы данных.

- numbackends: активных количество подключений.
- xact_commit и xact_rollback : Количество успешных и неудачных транзакций. blks_read и blks_hit : Общее количество блоков, прочитанных с диска, и блоков, найденных в кэше (буфере).
- tup_returned , tup_fetched , tup_inserted , tup_updated , tup_deleted : Количество строк, которые были возвращены, извлечены, вставлены, обновлены или удалены. 
- deadlocks : Количество обнаруженных тупиковых блокировок.
- conflicts : Количество потенциальных конфликтов при репликации данных, например, в
средах с множественной мастер-репликацией.
- temp_files и temp_bytes : Количество временных файлов, созданных базой данных, и объем данных в этих файлах
- blk_read_time и blk_write_time : Общее время, затраченное на чтение и запись блоков, в миллисекундах

 
# Большое количество транзакций.
 
Большое количество xact_rollback - это подозрительно, много отмененных иранзакций
Большое количество blk_reads относительно blk_hit - это говорит, что кэш может быть настроен не оптимально. 
Большое количество tup_fetched относительно tup_returned - это говорит, что кэш может быть настроен не оптимально.
Много deadlocks	- pначит, что один процесс может ждать другой, не очень хорошо.
 
## pg_class 
Информация в разрезе классов базы данных: таблицы, индексы, представления и другие.

- relpages : Приблизительное количество дисковых страниц, занятых объектом.
- reltuples : Приблизительное количество строк в объекте.
- relkind : Тип объекта (например, 'r' для обычной таблицы, 'i' для индекса, 'v' для представления, 'm' для материализованного представления и так далее). 
- relhasindex : Указывает, существуют ли индексы на этой таблице.
- relisshared : Указывает, является ли объект общим между всеми базами данных в кластере.

r : Обычная таблица (relation).
i : Индекс.
S : Последовательность (sequence).
v : Представление (view).
m : Материализованное представление (materialized view).
c : Композитный тип (composite type). Это описывает структуру строки для таблицы.
t : TOAST-таблица. TOAST (The Oversized-Attribute Storage Technique) — это механизм для оптимизации хранения больших полей.
f : Иностранный таблица (foreign table).

## pg_stats
Подробную статистику по каждому столбцу таблицы в базе данных. Эта статистика очень важна для оптимизатора запросов, так как она помогает ему делать более информированные решения о том, как выполнять запросы.

- null_frac : Доля строк в столбце, содержащих значение NULL .
- n_distinct : Приблизительное количество различных значений в столбце. Если значение отрицательное, оно представляет долю уникальных значений относительно общего количества строк в таблице.
- most_common_vals : Список наиболее часто встречающихся значений в столбце. 
- most_common_freqs : Частоты наиболее часто встречающихся значений. 
- histogram_bounds : Границы гистограммы для распределения значений в столбце. Это
используется для определения распределения значений в столбце, кроме наиболее часто встречающихся.
- correlation : Корреляция между физическим порядком строк и порядком значений в столбце. Это может помочь оптимизатору запросов решить, стоит ли использовать индекс для данного столбца.

## pg_statistic_ext 
Иногда нужно собрать более сложную статистику по колонкам, например, использовать несколько колонок.
Create statistics stat_name(dependencies|ndistinct) on field_name1, field_name2
from table_name
- ndistinct - количество уникальный записей. (Уникальные фамилия, имя, отчество).
Использовать, когда много уникальных комбинаций.
- dependencies - функциональные зависимости. (Регион – Город). Когда значение одной из колонок влияет на другую.
- mcv - Most Common Value. Часто встречающиеся значения. Когда некоторые значения встречаются чаще, чем другие.

## pg_stat_activity
Статистика о текущей активности.
- pid : Идентификатор процесса на уровне операционной системы. backend_start : Время, когда этот процесс сервера был запущен. query_start : Время начала текущего запроса.
- wait_event_type и wait_event : Тип и название события, на котором процесс в настоящее время ожидает (если ожидает).
- query : Текст текущего выполняемого запроса или последнего запроса, который был выполнен.
- state : Текущее состояние процесса (например, active , idle , idle in transaction ).

## pg_stat_user_tables Статистика в разрезе таблиц.

relname : Имя таблицы.
seq_scan : Количество последовательных сканирований таблицы. seq_tup_read : Количество строк, прочитанных во время последовательных сканирований.
idx_scan : Количество сканирований индекса таблицы.
idx_tup_fetch : Количество строк, извлеченных через индексные сканирования.
n_tup_ins : Количество строк, вставленных в таблицу. n_tup_upd : Количество строк, обновленных в таблице. n_tup_del : Количество строк, удаленных из таблицы.
n_tup_hot_upd : Количество "горячих" обновлений строк (обновлений, которые не изменяют индексные записи)
и n_dead_tup : Количество "живых" (активно используемых) и "мертвых" (отмеченных для удаления или обновления) строк в таблице.
 
## pg_stat_user_indexes 
Статистика в разрезе идексов

- idx_scan : Количество раз, когда индекс был использован для выполнения сканирований. Высокое значение указывает на то, что индекс эффективно используется для улучшения производительности запросов.
- idx_tup_read : Количество строк таблицы, прочитанных при использовании индекса. Это число может быть больше, чем фактическое количество возвращенных строк, если индекс не покрывает все столбцы, используемые в запросе.
- idx_tup_fetch : Количество строк таблицы, фактически извлеченных при использовании индекса. Это показывает, сколько строк было получено непосредственно через индексные операции.

## pg_stat_statements
Статическое представления для запросов.
- rows : Общее количество строк, которые были возвращены или затронуты запросом. 
- shared_blks_hit ,  shared_blks_read , shared_blks_dirtied , shared_blks_written : Статистика использования общих блоков памяти, включая количество попаданий в кэш, чтений, «загрязнений» и записей.
- local_blks_hit , local_blks_read , local_blks_dirtied , local_blks_written : 

Аналогичная статистика, но для локальных блоков памяти.
- calls : Количество раз, которое этот запрос был выполнен.
- total_time : Общее время, затраченное на выполнение данного запроса, в миллисекундах.
- min_time , max_time , mean_time , stddev_time : Минимальное, максимальное, среднее и стандартное отклонение времени выполнения запроса.
- blk_read_time , blk_write_time : Общее время, затраченное на чтение и запись блоков.