

# Материалы для изучения:
* [Логическое устройство Постгреса](https://aristov.tech/blog/logicheskoe-ustrojstv-postgresa/)
* [DEV1-12. 05. Логическая структура данных](https://www.youtube.com/watch?v=cOjAk1g0stE)
* [PostgreSQL Privileges & User Management – What You Should Know](https://severalnines.com/blog/postgresql-privileges-user-management-what-you-should-know/)
* [* PostgreS'L - Проверка подлинности LDAP на active Directory](https://techexpert.tips/ru/postgresql-ru/postgresl-проверка-подлинности-ldap-на-active-directory/)
* [PostgreSQL foreign data wrapper](https://github.com/tds-fdw/tds_fdw)
* [Foreign Data Wrapper for Oracle](https://github.com/laurenz/oracle_fdw)
* [Managing PostgreSQL users and roles](https://aws.amazon.com/ru/blogs/database/managing-postgresql-users-and-roles/)
* [Postgres - отменить доступ к общедоступной схеме для пользователя](https://dba.stackexchange.com/questions/261542/postgres-revoke-access-to-public-schema-for-a-user)
* [Обеспечение безопасности базы данных PostgreSQL](https://habr.com/ru/articles/550882/)
* [Postgres - Revoke access to public schema for a user](https://dba.stackexchange.com/questions/261542/postgres-revoke-access-to-public-schema-for-a-user)
* [Привилегии в PostgreSQL](https://sysadminium.ru/privilegii_v_postgresql/#Gruppovye_privilegii)
* [Как работать с пользователями в PostgreSQL](https://www.dmosk.ru/miniinstruktions.php?mini=postgresql-users)

# Таблица
r = ordinary table,
i = index,
S = sequence,
v = view, https://postgrespro.ru/docs/postgrespro/13/sql-createview
m = materialized view, https://postgrespro.ru/docs/postgrespro/13/sql-creatematerializedview
c = composite type, https://www.postgresql.org/docs/13/rowtypes.html
t = TOAST table,
f = foreign table, https://postgrespro.ru/docs/postgrespro/13/sql-createforeigntable

https://www.postgresql.org/docs/13/catalog-pg-class.html

# Создание БД
CREATE DATABASE имя
[ [ WITH ] [ OWNER [=] имя_пользователя ]
[ TEMPLATE [=] шаблон ]
[ ENCODING [=] кодировка ]
[ LOCALE [=] локаль[@провайдер] ]
[ LC_COLLATE [=] категория_сортировки[@провайдер] ]
[ LC_CTYPE [=] категория_типов_символов ]
[ TABLESPACE [=] табл_пространство ]
[ ALLOW_CONNECTIONS [=] разр_подключения ]
[ CONNECTION LIMIT [=] предел_подключений ]
[ IS_TEMPLATE [=] это_шаблон ] ]
https://postgrespro.ru/docs/postgresql/14/sql-createdatabase
Список диалектов и правил сортировки https://postgrespro.ru/docs/postgresql/14/locale

# Создание схемы
CREATE SCHEMA имя_схемы [ AUTHORIZATION указание_роли ] [ элемент_схемы [ ... ] ]
CREATE SCHEMA AUTHORIZATION указание_роли [ элемент_схемы [ ... ] ]
CREATE SCHEMA IF NOT EXISTS имя_схемы [ AUTHORIZATION указание_роли ]
CREATE SCHEMA IF NOT EXISTS AUTHORIZATION указание_роли
Здесь указание_роли :
имя_пользователя
| CURRENT_USER
| SESSION_USER
https://postgrespro.ru/docs/postgresql/14/sql-createschema


# Роль
пользователь СУБД
может включать в себя другие роли — быть «групповой ролью»
никак не связана с пользователем ОС
определяется на уровне кластера
Псевдороль public
неявно включает в себя все остальные роли
https://postgrespro.ru/docs/postgresql/14/sql-createrole

CREATE ROLE роль [WITH] атрибут [атрибут ...]
LOGIN возможность подключения
SUPERUSER суперпользователь
CREATEDB возможность создавать базы данных
CREATEROLE возможность создавать роли
REPLICATION использование протокола репликации
…
NOLOGIN
NOCREATEDB
...
https://www.postgresql.org/docs/current/sql-createrole.html


# Включение роли в группу
роль1: GRANT группа TO роль2;
Исключение роли из группы
роль1: REVOKE группа FROM роль2;
Право управления участием в групповой роли имеют:
любая роль — в самой себе
роль с атрибутом SUPERUSER — в любой роли
роль с атрибутом CREATEROLE — в любой, кроме суперпользовательской

Включение в группу с передачей права управления
роль1: GRANT группа ТО роль2 WITH ADMIN OPTION;
теперь роль2 управляет группой, включая передачу права управления:
роль2: GRANT группа ТО рольЗ WITH ADMIN OPTION;
роль2: GRANT группа ТО роль4 WITH ADMIN OPTION;
Отзыв права передачи управления
роль1: REVOKE ADMIN OPTION FOR группа FROM роль2;

Владелец объекта
роль, создавшая объект
(а также роли, включенные в нее)
может быть изменен командой ALTER... OWNER ТО роль
\dt table name

# Привилегии
SELECT
INSERT
UPDATE
DELETE
TRUNCATE
CREATE
CONNECT
EXECUTE
...
Набор прав, применимых к определённому объекту, зависит от типа объекта (таблица, функция и т. д.)

https://postgrespro.ru/docs/postgresql/14/sql-grant

GRANT && REVOKE
\dp mytable —> miriam=arwdDxt
имя_роли=хххх ••права, назначенные роли
=хххх -- права, назначенные PUBLIC
г- SELECT (“read", чтение)
w- UPDATE ("write", запись)
а- INSERT ('append", добавление)
d- DELETE
D - TRUNCATE
X - REFERENCES
t- TRIGGER
X- EXECUTE
U- USAGE
C - CREATE
C- CONNECT
T- TEMPORARY
arwdDxt- ALL PRIVILEGES (все права для таблиц; для других обьектов другие)
*- право передачи заданного права
/уууу -• роль, назначившая зто право


GRANT SELECT ON mytable TO PUBLIC;
GRANT SELECT, UPDATE, INSERT ON mytable TO admin;
GRANT SELECT (col1), UPDATE (col1) ON mytable TO miriam_rw;

https://postgrespro.ru/docs/postgrespro/13/sql-revoke
https://postgrespro.ru/docs/postgrespro/13/sql-alterdefaultprivileges

Суперпользователи
    полный доступ ко всем объектам     прав на вызов ХП (security definer/invoker)
Владельцы
    доступ в рамках выданных привилегий (изначально получает полный набор) а также действия, не регламентируемые привилегиями, например: удаление, выдача и отзыв привилегий и т. п.
Остальные роли
    доступ исключительно в рамках выданных привилегий

## Выдача привилегии с правом передачи
роль1: GRANT привилегии ON объект ТО роль2 WITH GRANT OPTION;
Отзыв привилегии
роль1: REVOKE привилегии ON объект FROM роль2 CASCADE;
Отзыв права передачи
роль1: REVOKE GRANT OPTION FOR привилегии ON объект FROM роль2
CASCADE;


# LDAP
Установка LDAP+настройка
How to connect Postgres with LDAP (with StartTLS) | EDB
настройка LDAP для AD
Учебный PostgreS'L - LdAP Аутентификация на активный каталог



Отнять права:
REVOKE SELECT ON ALL TABLES IN SCHEMA testnm FROM readonly;

\dn+   -- Посмотреть права на схемы:

Посмотреть права пользователя на таблицы:
  SELECT *
  FROM pg_tables
  WHERE tableowner = 'testread';